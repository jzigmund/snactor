---
inputs:
  - name: source_host
    type: BaseTypeString
  
  - name: source_user_name
    type: BaseTypeString

  - name: target_host
    type: BaseTypeString

  - name: target_user_name
    type: BaseTypeString

  - name: container_directory
    type: BaseTypeString

  - name: csv_excluded_paths
    type: BaseTypeString

description: |
  Copy the files from a source to a target host by using Rsync

  Inputs:
    source_host         - source system hostname
    source_user_name    - source system username
    target_host         - target system hostname
    container_directory - name of the container directory
    csv_excluded_paths  - excluded file paths from copying
  Outputs:
    None

executor:
  type: bash
  arguments:
    - "@source_host.value@"
    - "@source_user_name.value@"
    - "@target_host.value@"
    - "@target_user_name.value@"
    - "@container_directory.value@"
    - "@csv_excluded_paths.value@"
  payload: |
    SOURCE_HOST=$1
    SOURCE_USER=$2
    TARGET_HOST=$3
    TARGET_USER=$4
    STORAGE_PATH=$5
    EXCLUDED_PATHS=$6

    # Check path
    if [ -z $STORAGE_PATH ]; then
        >&2 echo "Storage path must be set"
        exit 1
    fi

    set -f
    EXCLUDED_PATHS=$(echo $EXCLUDED_PATHS | tr ',' "\n" | sed -e 's/^\s*\(.*\)\s*$/\1/')
    EXCLUDE_OPTIONS=""

    for path in $EXCLUDED_PATHS; do
        EXCLUDE_OPTIONS="--exclude=$path $EXCLUDE_OPTIONS"
    done

    # Setting up the SSH options parameter
    if [ ! -z $SSH_OPTIONS ]; then
        SSH_OPTIONS=" -o $SSH_OPTIONS" 
    fi

    rsync -aAX -r $EXCLUDE_OPTIONS ${SOURCE_USER}@${SOURCE_HOST}:/ $STORAGE_PATH

    # In case of a remote target
    if [ "localhost" != $TARGET_HOST ] && [ "127.0.0.1" != $TARGET_HOST ]; then
      rsync -aAX -r ${STORAGE_PATH}/ ${TARGET_USER}@${TARGET_HOST}:${STORAGE_PATH}/
    fi
    exit 0;
